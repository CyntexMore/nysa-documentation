---
title: Discord Integration
description: Specifications for Nysa's official Discord integration.
---

import { Steps, Card } from '@astrojs/starlight/components';

The Discord integration is Nysa's first-class adapter for Discord, built on top of [Discord.js](https://discord.js.org/). It provides comprehensive support for all Discord features including slash commands, message interactions, threads, reactions, voice calls, and moderation tools.

This adapter implements the [`SocialPlatform`](/specifications/social-sdk/social-sdk#socialplatform-interface) interface while exposing Discord-specific features for advanced use cases.

## Voice Calls

For voice call specifications including audio pipeline, Opus transcoding, Whisper integration, and TTS setup, see the [Discord Voice Calls](/specifications/social-sdk/discord/voice-call) specification.

## User Identification

Discord user IDs are the **canonical identifier** for users in Nysa. Unlike usernames (which can change), display names (which can change), or discriminators (which were removed), the user ID is a permanent, unique snowflake that always identifies the same account.

### Why User IDs?

* **Permanence**: User IDs never change, even if the user changes their username, display name, avatar, or any other profile attribute
* **Uniqueness**: Each Discord account has exactly one unique ID (e.g., `686175431539556565`)
* **Memory Integration**: The [`userId`](/specifications/memory-engine#memory-object) field in nmgine memories should store Discord user IDs for reliable cross-session identification
* **Mention Resolution**: User IDs are used in Discord's mention format (`<@686175431539556565>`) and can always be resolved to the current user profile

### User ID Format

Discord user IDs are 17-20 digit snowflakes:

```typescript
// Example user ID
const userId = "686175431539556565"; // Always a string, never a number (precision loss)

// Accessing from Discord.js
const userId = message.author.id;        // "686175431539556565"
const userId = interaction.user.id;      // "686175431539556565"
const userId = guildMember.id;           // "686175431539556565"
```

### Storage in nmgine

When saving memories tied to Discord users, always use the Discord user ID:

```typescript
interface Memory {
  id: number;
  userId: ["686175431539556565"]; // Discord user ID(s)
  shortName: string;
  type: MemoryType;
  content: string;
  // ...
}
```

This ensures that even if a user changes their username from `johndoe` to `janesmith`, Nysa still recognizes them and retrieves their associated memories correctly.

## Architecture

The Discord adapter follows a layered architecture:

1. **Gateway Layer**: WebSocket connection to Discord Gateway for real-time events
2. **REST Layer**: HTTP API client for sending messages, managing channels, etc.
3. **Command Layer**: Slash command registration, handling, and autocomplete
4. **Event Layer**: Normalized event handling for messages, reactions, interactions
5. **Voice Layer**: Voice connection management (see [Voice Calls](/specifications/social-sdk/discord/voice-call))

## Data Model

### DiscordMessage

Extends [`PlatformMessage`](/specifications/social-sdk/social-sdk#platformmessage) with Discord-specific fields:

```typescript
interface DiscordMessage extends PlatformMessage {
  // Discord-specific fields
  type: MessageType;
  flags: MessageFlags;
  mentionEveryone: boolean;
  mentionRoles: string[];
  pinned: boolean;
  webhookId?: string;
  applicationId?: string;
  activity?: MessageActivity;
  
  // Interaction context
  interaction?: {
    id: string;
    type: InteractionType;
    name: string;
    user: PlatformUser;
  };
  
  // Thread starter
  thread?: DiscordChannel; // If this message started a thread
  
  // Components (buttons, selects) that were sent with this message
  components?: MessageComponent[];
}

enum MessageType {
  Default = 0,
  RecipientAdd = 1,
  RecipientRemove = 2,
  Call = 3,
  ChannelNameChange = 4,
  ChannelIconChange = 5,
  ChannelPinnedMessage = 6,
  UserJoin = 7,
  GuildBoost = 8,
  GuildBoostTier1 = 9,
  GuildBoostTier2 = 10,
  GuildBoostTier3 = 11,
  ChannelFollowAdd = 12,
  GuildDiscoveryDisqualified = 14,
  GuildDiscoveryRequalified = 15,
  GuildDiscoveryGracePeriodInitialWarning = 16,
  GuildDiscoveryGracePeriodFinalWarning = 17,
  ThreadCreated = 18,
  Reply = 19,
  ChatInputCommand = 20,
  ThreadStarterMessage = 21,
  GuildInviteReminder = 22,
  ContextMenuCommand = 23,
  AutoModerationAction = 24,
  RoleSubscriptionPurchase = 25,
  InteractionPremiumUpsell = 26,
  StageStart = 27,
  StageEnd = 28,
  StageSpeaker = 29,
  StageTopic = 31,
  GuildApplicationPremiumSubscription = 32
}

enum MessageFlags {
  Crossposted = 1 << 0,
  IsCrosspost = 1 << 1,
  SuppressEmbeds = 1 << 2,
  SourceMessageDeleted = 1 << 3,
  Urgent = 1 << 4,
  HasThread = 1 << 5,
  Ephemeral = 1 << 6,
  Loading = 1 << 7,
  FailedToMentionSomeRolesInThread = 1 << 8,
  SuppressNotifications = 1 << 12,
  IsVoiceMessage = 1 << 13
}

interface MessageActivity {
  type: MessageActivityType;
  partyId?: string;
}

enum MessageActivityType {
  Join = 1,
  Spectate = 2,
  Listen = 3,
  JoinRequest = 5
}
```

### DiscordUser

Extends [`PlatformUser`](/specifications/social-sdk/social-sdk#platformuser) with Discord-specific fields:

```typescript
interface DiscordUser extends PlatformUser {
  discriminator: string; // Legacy discriminator (e.g., "1234")
  globalName?: string;   // Display name (new username system)
  bannerUrl?: string;
  accentColor?: number;
  locale?: string;
  verified?: boolean;
  email?: string;        // Requires OAuth2 scope
  flags: UserFlags;
  premiumType: PremiumType;
  publicFlags: UserFlags;
}

enum UserFlags {
  Staff = 1 << 0,
  Partner = 1 << 1,
  HypeSquad = 1 << 2,
  BugHunterLevel1 = 1 << 3,
  HypeSquadOnlineHouse1 = 1 << 6,
  HypeSquadOnlineHouse2 = 1 << 7,
  HypeSquadOnlineHouse3 = 1 << 8,
  PremiumEarlySupporter = 1 << 9,
  TeamPseudoUser = 1 << 10,
  BugHunterLevel2 = 1 << 14,
  VerifiedBot = 1 << 16,
  VerifiedDeveloper = 1 << 17,
  CertifiedModerator = 1 << 18,
  BotHTTPInteractions = 1 << 19,
  ActiveDeveloper = 1 << 22
}

enum PremiumType {
  None = 0,
  NitroClassic = 1,
  Nitro = 2,
  NitroBasic = 3
}
```

### DiscordGuild

```typescript
interface DiscordGuild {
  id: string;
  name: string;
  iconUrl?: string;
  splashUrl?: string;
  discoverySplashUrl?: string;
  ownerId: string;
  afkChannelId?: string;
  afkTimeout: number;
  widgetEnabled?: boolean;
  widgetChannelId?: string;
  verificationLevel: VerificationLevel;
  defaultMessageNotifications: MessageNotificationLevel;
  explicitContentFilter: ExplicitContentFilterLevel;
  roles: DiscordRole[];
  emojis: DiscordEmoji[];
  features: GuildFeature[];
  mfaLevel: MFALevel;
  systemChannelId?: string;
  systemChannelFlags: SystemChannelFlags;
  rulesChannelId?: string;
  maxPresences?: number;
  maxMembers?: number;
  vanityUrlCode?: string;
  description?: string;
  bannerUrl?: string;
  premiumTier: PremiumTier;
  premiumSubscriptionCount?: number;
  preferredLocale: string;
  publicUpdatesChannelId?: string;
  maxVideoChannelUsers?: number;
  maxStageVideoChannelUsers?: number;
  approximateMemberCount?: number;
  approximatePresenceCount?: number;
  welcomeScreen?: WelcomeScreen;
  nsfwLevel: GuildNSFWLevel;
  stickers: DiscordSticker[];
}

enum VerificationLevel {
  None = 0,
  Low = 1,
  Medium = 2,
  High = 3,
  VeryHigh = 4
}

enum MessageNotificationLevel {
  AllMessages = 0,
  OnlyMentions = 1
}

enum ExplicitContentFilterLevel {
  Disabled = 0,
  MembersWithoutRoles = 1,
  AllMembers = 2
}

enum MFALevel {
  None = 0,
  Elevated = 1
}

enum PremiumTier {
  None = 0,
  Tier1 = 1,
  Tier2 = 2,
  Tier3 = 3
}

enum GuildNSFWLevel {
  Default = 0,
  Explicit = 1,
  Safe = 2,
  AgeRestricted = 3
}

type GuildFeature = 
  | "ANIMATED_BANNER"
  | "ANIMATED_ICON"
  | "APPLICATION_COMMAND_PERMISSIONS_V2"
  | "AUTO_MODERATION"
  | "BANNER"
  | "COMMUNITY"
  | "CREATOR_MONETIZABLE_PROVISIONAL"
  | "CREATOR_STORE_PAGE"
  | "DEVELOPER_SUPPORT_SERVER"
  | "DISCOVERABLE"
  | "FEATURABLE"
  | "INVITES_DISABLED"
  | "INVITE_SPLASH"
  | "MEMBER_VERIFICATION_GATE_ENABLED"
  | "MORE_STICKERS"
  | "NEWS"
  | "PARTNERED"
  | "PREVIEW_ENABLED"
  | "RAID_ALERTS_DISABLED"
  | "ROLE_ICONS"
  | "ROLE_SUBSCRIPTIONS_AVAILABLE_FOR_PURCHASE"
  | "ROLE_SUBSCRIPTIONS_ENABLED"
  | "TICKETED_EVENTS_ENABLED"
  | "VANITY_URL"
  | "VERIFIED"
  | "VIP_REGIONS"
  | "WELCOME_SCREEN_ENABLED";
```

### DiscordChannel

Extends [`PlatformChannel`](/specifications/social-sdk/social-sdk#platformchannel) with Discord-specific fields:

```typescript
interface DiscordChannel extends PlatformChannel {
  // Discord-specific types
  type: DiscordChannelType;
  
  // Guild channels
  guildId?: string;
  permissionOverwrites: PermissionOverwrite[];
  
  // Text channels
  topic?: string;
  lastMessageId?: string;
  lastPinTimestamp?: Date;
  defaultAutoArchiveDuration?: number; // Thread auto-archive in minutes
  
  // Voice/Stage channels
  bitrate?: number;
  userLimit?: number;
  rtcRegion?: string;
  videoQualityMode?: VideoQualityMode;
  
  // Forum channels
  availableTags?: ForumTag[];
  defaultReactionEmoji?: DefaultReactionEmoji;
  defaultThreadRateLimitPerUser?: number;
  defaultSortOrder?: SortOrderType;
  defaultForumLayout?: ForumLayoutType;
  
  // Thread-specific
  messageCount?: number;
  memberCount?: number;
  archived?: boolean;
  archiverId?: string;
  autoArchiveDuration?: number;
  locked?: boolean;
  invitable?: boolean;
  appliedTags?: string[]; // Forum post tags
}

enum DiscordChannelType {
  GuildText = 0,
  DM = 1,
  GuildVoice = 2,
  GroupDM = 3,
  GuildCategory = 4,
  GuildAnnouncement = 5,
  AnnouncementThread = 10,
  PublicThread = 11,
  PrivateThread = 12,
  GuildStageVoice = 13,
  GuildDirectory = 14,
  GuildForum = 15,
  GuildMedia = 16
}

enum VideoQualityMode {
  Auto = 1,
  Full = 2
}

enum SortOrderType {
  LatestActivity = 0,
  CreationDate = 1
}

enum ForumLayoutType {
  NotSet = 0,
  ListView = 1,
  GalleryView = 2
}

interface PermissionOverwrite {
  id: string;
  type: "role" | "member";
  allow: bigint; // Permission flags
  deny: bigint;  // Permission flags
}

interface ForumTag {
  id: string;
  name: string;
  moderated: boolean;
  emojiId?: string;
  emojiName?: string;
}

interface DefaultReactionEmoji {
  emojiId?: string;
  emojiName?: string;
}
```

### DiscordRole

```typescript
interface DiscordRole {
  id: string;
  name: string;
  color: number;
  hoist: boolean;
  iconUrl?: string;
  unicodeEmoji?: string;
  position: number;
  permissions: bigint;
  managed: boolean;
  mentionable: boolean;
  tags?: RoleTags;
}

interface RoleTags {
  botId?: string;
  integrationId?: string;
  premiumSubscriber?: boolean; // null in API, indicates Nitro booster role
  subscriptionListingId?: string;
  availableForPurchase?: boolean;
  guildConnections?: boolean;
}
```

### DiscordEmoji

```typescript
interface DiscordEmoji {
  id: string; // null for Unicode emojis
  name: string;
  roles?: string[];
  user?: DiscordUser;
  requireColons?: boolean;
  managed?: boolean;
  animated?: boolean;
  available?: boolean;
}
```

## Slash Commands

Slash commands provide a structured way for users to interact with Nysa. They appear when typing `/` and provide autocomplete, validation, and clear documentation.

### Command Registration

```typescript
interface SlashCommand {
  name: string;
  nameLocalizations?: Record<string, string>;
  description: string;
  descriptionLocalizations?: Record<string, string>;
  options?: CommandOption[];
  defaultMemberPermissions?: bigint;
  dmPermission?: boolean;
  defaultPermission?: boolean; // Deprecated
  nsfw?: boolean;
  integrationTypes?: ApplicationIntegrationType[];
  contexts?: InteractionContextType[];
}

type CommandOption = 
  | StringOption
  | IntegerOption
  | NumberOption
  | BooleanOption
  | UserOption
  | ChannelOption
  | RoleOption
  | MentionableOption
  | AttachmentOption;

interface BaseOption {
  name: string;
  nameLocalizations?: Record<string, string>;
  description: string;
  descriptionLocalizations?: Record<string, string>;
  required?: boolean;
}

interface StringOption extends BaseOption {
  type: ApplicationCommandOptionType.String;
  choices?: CommandChoice[];
  autocomplete?: boolean;
  minLength?: number;
  maxLength?: number;
}

interface IntegerOption extends BaseOption {
  type: ApplicationCommandOptionType.Integer;
  choices?: CommandChoice[];
  autocomplete?: boolean;
  minValue?: number;
  maxValue?: number;
}

interface NumberOption extends BaseOption {
  type: ApplicationCommandOptionType.Number;
  choices?: CommandChoice[];
  autocomplete?: boolean;
  minValue?: number;
  maxValue?: number;
}

interface BooleanOption extends BaseOption {
  type: ApplicationCommandOptionType.Boolean;
}

interface UserOption extends BaseOption {
  type: ApplicationCommandOptionType.User;
}

interface ChannelOption extends BaseOption {
  type: ApplicationCommandOptionType.Channel;
  channelTypes?: ChannelType[];
}

interface RoleOption extends BaseOption {
  type: ApplicationCommandOptionType.Role;
}

interface MentionableOption extends BaseOption {
  type: ApplicationCommandOptionType.Mentionable;
}

interface AttachmentOption extends BaseOption {
  type: ApplicationCommandOptionType.Attachment;
}

interface CommandChoice {
  name: string;
  nameLocalizations?: Record<string, string>;
  value: string | number;
}

enum ApplicationCommandOptionType {
  SubCommand = 1,
  SubCommandGroup = 2,
  String = 3,
  Integer = 4,
  Boolean = 5,
  User = 6,
  Channel = 7,
  Role = 8,
  Mentionable = 9,
  Number = 10,
  Attachment = 11
}

enum ApplicationIntegrationType {
  GuildInstall = 0,
  UserInstall = 1
}

enum InteractionContextType {
  Guild = 0,
  BotDM = 1,
  PrivateChannel = 2
}
```

### Built-in Commands

Nysa should register these commands by default:

| Command | Description | Options |
|:--------|:------------|:--------|
| `/talk` | Start a conversation with Nysa | `topic` (string, optional): What to talk about |
| `/remember` | Save a fact to memory | `fact` (string, required): The fact to remember |
| `/forget` | Remove a fact from memory | `fact` (string, autocomplete): The fact to forget |
| `/voice join` | Join the current voice channel | - |
| `/voice leave` | Leave the voice channel | - |
| `/persona` | Change Nysa's personality | `name` (string, autocomplete): Persona to load |
| `/status` | Check Nysa's system status | - |
| `/help` | Show available commands | `command` (string, optional): Specific command help |

### Command Handling

```typescript
interface CommandInteraction {
  id: string;
  applicationId: string;
  type: InteractionType.ApplicationCommand;
  data: CommandInteractionData;
  guildId?: string;
  channel?: DiscordChannel;
  channelId?: string;
  member?: GuildMember;
  user: DiscordUser;
  token: string;
  version: number;
  message?: DiscordMessage; // For message commands
  appPermissions?: bigint;
  locale: string;
  guildLocale?: string;
  entitlements: Entitlement[];
  authorizingIntegrationOwners: Record<ApplicationIntegrationType, string>;
  context?: InteractionContextType;
}

interface CommandInteractionData {
  id: string;
  name: string;
  type: ApplicationCommandType;
  resolved?: ResolvedData;
  options?: CommandInteractionOption[];
  guildId?: string;
  targetId?: string; // For user/message commands
}

interface CommandInteractionOption {
  name: string;
  type: ApplicationCommandOptionType;
  value?: string | number | boolean;
  options?: CommandInteractionOption[];
  focused?: boolean; // For autocomplete
}

enum InteractionType {
  Ping = 1,
  ApplicationCommand = 2,
  MessageComponent = 3,
  ApplicationCommandAutocomplete = 4,
  ModalSubmit = 5
}

enum ApplicationCommandType {
  ChatInput = 1,
  User = 2,
  Message = 3
}
```

### Autocomplete

For commands with `autocomplete: true`, Nysa provides suggestions as the user types:

```typescript
interface AutocompleteInteraction {
  id: string;
  applicationId: string;
  type: InteractionType.ApplicationCommandAutocomplete;
  data: AutocompleteData;
  guildId?: string;
  channelId?: string;
  channel?: DiscordChannel;
  member?: GuildMember;
  user: DiscordUser;
  token: string;
  version: number;
  appPermissions?: bigint;
  locale: string;
  guildLocale?: string;
}

interface AutocompleteData {
  id: string;
  name: string;
  type: ApplicationCommandType.ChatInput;
  options: AutocompleteOption[];
}

interface AutocompleteOption {
  name: string;
  type: ApplicationCommandOptionType;
  value: string | number;
  focused: boolean;
}

// Response format
interface AutocompleteResponse {
  choices: AutocompleteChoice[];
}

interface AutocompleteChoice {
  name: string;
  nameLocalizations?: Record<string, string>;
  value: string | number;
}
```

## Message Components

Discord supports interactive components that can be attached to messages:

### Buttons

```typescript
interface ButtonComponent {
  type: ComponentType.Button;
  style: ButtonStyle;
  label?: string;
  emoji?: PartialEmoji;
  customId?: string;
  url?: string;
  disabled?: boolean;
  skuId?: string; // For premium buttons
}

enum ButtonStyle {
  Primary = 1,    // Blurple
  Secondary = 2,  // Grey
  Success = 3,    // Green
  Danger = 4,     // Red
  Link = 5,       // Grey with link icon
  Premium = 6     // Premium (requires sku_id)
}
```

### Select Menus

```typescript
interface StringSelectComponent {
  type: ComponentType.StringSelect;
  customId: string;
  options: SelectOption[];
  placeholder?: string;
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface SelectOption {
  label: string;
  value: string;
  description?: string;
  emoji?: PartialEmoji;
  default?: boolean;
}

interface UserSelectComponent {
  type: ComponentType.UserSelect;
  customId: string;
  placeholder?: string;
  defaultValues?: SelectDefaultValue[];
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface RoleSelectComponent {
  type: ComponentType.RoleSelect;
  customId: string;
  placeholder?: string;
  defaultValues?: SelectDefaultValue[];
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface MentionableSelectComponent {
  type: ComponentType.MentionableSelect;
  customId: string;
  placeholder?: string;
  defaultValues?: SelectDefaultValue[];
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface ChannelSelectComponent {
  type: ComponentType.ChannelSelect;
  customId: string;
  placeholder?: string;
  defaultValues?: SelectDefaultValue[];
  channelTypes?: ChannelType[];
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface SelectDefaultValue {
  id: string;
  type: "user" | "role" | "channel";
}

enum ComponentType {
  ActionRow = 1,
  Button = 2,
  StringSelect = 3,
  TextInput = 4,
  UserSelect = 5,
  RoleSelect = 6,
  MentionableSelect = 7,
  ChannelSelect = 8
}

interface PartialEmoji {
  id?: string;
  name?: string;
  animated?: boolean;
}
```

### Text Input (Modals)

```typescript
interface TextInputComponent {
  type: ComponentType.TextInput;
  customId: string;
  style: TextInputStyle;
  label: string;
  minLength?: number;
  maxLength?: number;
  required?: boolean;
  value?: string;
  placeholder?: string;
}

enum TextInputStyle {
  Short = 1,      // Single-line
  Paragraph = 2   // Multi-line
}

interface Modal {
  customId: string;
  title: string;
  components: ActionRowComponent[]; // Text inputs only, max 5
}

interface ActionRowComponent {
  type: ComponentType.ActionRow;
  components: TextInputComponent[];
}
```

## Threads

Discord threads are supported as first-class citizens:

```typescript
interface ThreadManager {
  // Create a thread
  create(options: ThreadCreateOptions): Promise<DiscordChannel>;
  
  // Join a thread
  join(threadId: string): Promise<void>;
  
  // Leave a thread
  leave(threadId: string): Promise<void>;
  
  // Archive a thread
  archive(threadId: string, locked?: boolean): Promise<void>;
  
  // Unarchive a thread
  unarchive(threadId: string): Promise<void>;
  
  // Delete a thread
  delete(threadId: string): Promise<void>;
  
  // Add a member to a private thread
  addMember(threadId: string, userId: string): Promise<void>;
  
  // Remove a member from a thread
  removeMember(threadId: string, userId: string): Promise<void>;
  
  // Get thread members
  getMembers(threadId: string): Promise<ThreadMember[]>;
  
  // List active threads
  fetchActive(guildId?: string): Promise<DiscordChannel[]>;
  
  // List archived threads
  fetchArchived(options?: FetchArchivedOptions): Promise<{
    threads: DiscordChannel[];
    members: ThreadMember[];
    hasMore: boolean;
  }>;
}

interface ThreadCreateOptions {
  name: string;
  autoArchiveDuration: 60 | 1440 | 4320 | 10080; // Minutes (1h, 24h, 3d, 7d)
  rateLimitPerUser?: number;
  message?: SendMessageRequest; // Starter message
  invitable?: boolean; // Private threads only
  type?: ChannelType.PublicThread | ChannelType.PrivateThread | ChannelType.AnnouncementThread;
  appliedTags?: string[]; // Forum tags
}

interface ThreadMember {
  id?: string;
  userId?: string;
  joinTimestamp: Date;
  flags: number;
  member?: GuildMember;
}

interface FetchArchivedOptions {
  type?: "public" | "private";
  before?: string; // Snowflake
  limit?: number;
}
```

## Reactions

```typescript
interface ReactionManager {
  // Add a reaction
  add(messageId: string, channelId: string, emoji: string): Promise<void>;
  
  // Remove bot's reaction
  removeOwn(messageId: string, channelId: string, emoji: string): Promise<void>;
  
  // Remove a user's reaction
  removeUser(messageId: string, channelId: string, emoji: string, userId: string): Promise<void>;
  
  // Remove all reactions
  removeAll(messageId: string, channelId: string): Promise<void>;
  
  // Remove all reactions of a specific emoji
  removeEmoji(messageId: string, channelId: string, emoji: string): Promise<void>;
  
  // Get users who reacted with an emoji
  fetchUsers(messageId: string, channelId: string, emoji: string, options?: {
    limit?: number;
    after?: string;
  }): Promise<DiscordUser[]>;
}
```

## Guild Management

```typescript
interface GuildManager {
  // Fetch guild
  fetch(guildId: string): Promise<DiscordGuild>;
  
  // Leave guild
  leave(guildId: string): Promise<void>;
  
  // Get guild preview (for non-members)
  fetchPreview(guildId: string): Promise<GuildPreview>;
  
  // Ban a user
  ban(guildId: string, userId: string, options?: BanOptions): Promise<void>;
  
  // Unban a user
  unban(guildId: string, userId: string, reason?: string): Promise<void>;
  
  // Kick a member
  kick(guildId: string, userId: string, reason?: string): Promise<void>;
  
  // Fetch bans
  fetchBans(guildId: string, options?: { limit?: number; before?: string; after?: string }): Promise<Ban[]>;
  
  // Fetch audit logs
  fetchAuditLogs(guildId: string, options?: AuditLogOptions): Promise<AuditLog>;
  
  // Get guild widget
  fetchWidget(guildId: string): Promise<GuildWidget>;
  
  // Get guild widget settings
  fetchWidgetSettings(guildId: string): Promise<GuildWidgetSettings>;
}

interface BanOptions {
  deleteMessageSeconds?: number; // Delete messages from last N seconds (0-604800)
  reason?: string;
}

interface Ban {
  reason?: string;
  user: DiscordUser;
}

interface AuditLogOptions {
  userId?: string;
  actionType?: AuditLogEvent;
  before?: string;
  after?: string;
  limit?: number;
}

enum AuditLogEvent {
  GuildUpdate = 1,
  ChannelCreate = 10,
  ChannelUpdate = 11,
  ChannelDelete = 12,
  ChannelOverwriteCreate = 13,
  ChannelOverwriteUpdate = 14,
  ChannelOverwriteDelete = 15,
  MemberKick = 20,
  MemberPrune = 21,
  MemberBanAdd = 22,
  MemberBanRemove = 23,
  MemberUpdate = 24,
  MemberRoleUpdate = 25,
  MemberMove = 26,
  MemberDisconnect = 27,
  BotAdd = 28,
  RoleCreate = 30,
  RoleUpdate = 31,
  RoleDelete = 32,
  InviteCreate = 40,
  InviteUpdate = 41,
  InviteDelete = 42,
  WebhookCreate = 50,
  WebhookUpdate = 51,
  WebhookDelete = 52,
  EmojiCreate = 60,
  EmojiUpdate = 61,
  EmojiDelete = 62,
  MessageDelete = 72,
  MessageBulkDelete = 73,
  MessagePin = 74,
  MessageUnpin = 75,
  IntegrationCreate = 80,
  IntegrationUpdate = 81,
  IntegrationDelete = 82,
  StageInstanceCreate = 83,
  StageInstanceUpdate = 84,
  StageInstanceDelete = 85,
  StickerCreate = 90,
  StickerUpdate = 91,
  StickerDelete = 92,
  GuildScheduledEventCreate = 100,
  GuildScheduledEventUpdate = 101,
  GuildScheduledEventDelete = 102,
  ThreadCreate = 110,
  ThreadUpdate = 111,
  ThreadDelete = 112,
  ApplicationCommandPermissionUpdate = 121,
  AutoModerationRuleCreate = 140,
  AutoModerationRuleUpdate = 141,
  AutoModerationRuleDelete = 142,
  AutoModerationBlockMessage = 143,
  AutoModerationFlagToChannel = 144,
  AutoModerationUserCommunicationDisabled = 145,
  CreatorMonetizationRequestCreated = 150,
  CreatorMonetizationTermsAccepted = 151,
  OnboardingPromptCreate = 163,
  OnboardingPromptUpdate = 164,
  OnboardingPromptDelete = 165,
  OnboardingCreate = 166,
  OnboardingUpdate = 167,
  HomeSettingsCreate = 190,
  HomeSettingsUpdate = 191
}
```

## Presence and Rich Presence

```typescript
interface PresenceManager {
  // Set bot's presence
  set(presence: PresenceData): Promise<void>;
  
  // Clear presence
  clear(): Promise<void>;
}

interface PresenceData {
  status?: "online" | "idle" | "dnd" | "invisible" | "offline";
  afk?: boolean;
  activities?: Activity[];
  since?: number | null;
}

interface Activity {
  name: string;
  type: ActivityType;
  url?: string;
  createdAt: number;
  timestamps?: ActivityTimestamps;
  applicationId?: string;
  details?: string;
  state?: string;
  emoji?: ActivityEmoji;
  party?: ActivityParty;
  assets?: ActivityAssets;
  secrets?: ActivitySecrets;
  instance?: boolean;
  flags?: ActivityFlags;
  buttons?: ActivityButton[];
}

enum ActivityType {
  Playing = 0,
  Streaming = 1,
  Listening = 2,
  Watching = 3,
  Custom = 4,
  Competing = 5
}

interface ActivityTimestamps {
  start?: number;
  end?: number;
}

interface ActivityEmoji {
  name: string;
  id?: string;
  animated?: boolean;
}

interface ActivityParty {
  id?: string;
  size?: [current: number, max: number];
}

interface ActivityAssets {
  largeImage?: string;
  largeText?: string;
  smallImage?: string;
  smallText?: string;
}

interface ActivitySecrets {
  join?: string;
  spectate?: string;
  match?: string;
}

enum ActivityFlags {
  Instance = 1 << 0,
  Join = 1 << 1,
  Spectate = 1 << 2,
  JoinRequest = 1 << 3,
  Sync = 1 << 4,
  Play = 1 << 5,
  PartyPrivacyFriends = 1 << 6,
  PartyPrivacyVoiceChannel = 1 << 7,
  Embedded = 1 << 8
}

interface ActivityButton {
  label: string;
  url: string;
}
```

## Webhooks

```typescript
interface WebhookManager {
  // Create a webhook
  create(channelId: string, options: WebhookCreateOptions): Promise<Webhook>;
  
  // Fetch webhooks in a channel
  fetchChannelWebhooks(channelId: string): Promise<Webhook[]>;
  
  // Fetch webhooks in a guild
  fetchGuildWebhooks(guildId: string): Promise<Webhook[]>;
  
  // Fetch a specific webhook
  fetch(webhookId: string, token?: string): Promise<Webhook>;
  
  // Edit a webhook
  edit(webhookId: string, options: WebhookEditOptions, token?: string): Promise<Webhook>;
  
  // Delete a webhook
  delete(webhookId: string, token?: string): Promise<void>;
  
  // Send a message via webhook
  send(webhookId: string, token: string, message: WebhookMessage): Promise<DiscordMessage>;
}

interface Webhook {
  id: string;
  type: WebhookType;
  guildId?: string;
  channelId?: string;
  user?: DiscordUser;
  name: string;
  avatar?: string;
  token?: string;
  applicationId?: string;
  sourceGuild?: DiscordGuild;
  sourceChannel?: DiscordChannel;
  url?: string;
}

enum WebhookType {
  Incoming = 1,
  ChannelFollower = 2,
  Application = 3
}

interface WebhookCreateOptions {
  name: string;
  avatar?: Buffer | string; // Buffer or base64 data URI
  reason?: string;
}

interface WebhookEditOptions {
  name?: string;
  avatar?: Buffer | string | null;
  channel?: string; // Move to different channel
  reason?: string;
}

interface WebhookMessage extends Omit<SendMessageRequest, "channelId"> {
  username?: string; // Override webhook name
  avatarUrl?: string; // Override webhook avatar
  threadId?: string; // Send to thread
}
```

## Auto Moderation

```typescript
interface AutoModerationManager {
  // List rules
  fetchRules(guildId: string): Promise<AutoModerationRule[]>;
  
  // Fetch a rule
  fetchRule(guildId: string, ruleId: string): Promise<AutoModerationRule>;
  
  // Create a rule
  createRule(guildId: string, options: AutoModerationRuleCreateOptions): Promise<AutoModerationRule>;
  
  // Edit a rule
  editRule(guildId: string, ruleId: string, options: AutoModerationRuleEditOptions): Promise<AutoModerationRule>;
  
  // Delete a rule
  deleteRule(guildId: string, ruleId: string, reason?: string): Promise<void>;
}

interface AutoModerationRule {
  id: string;
  guildId: string;
  name: string;
  creatorId: string;
  eventType: AutoModerationEventType;
  triggerType: AutoModerationTriggerType;
  triggerMetadata: AutoModerationTriggerMetadata;
  actions: AutoModerationAction[];
  enabled: boolean;
  exemptRoles: string[];
  exemptChannels: string[];
}

enum AutoModerationEventType {
  MessageSend = 1
}

enum AutoModerationTriggerType {
  Keyword = 1,
  Spam = 3,
  KeywordPreset = 4,
  MentionSpam = 5,
  MemberProfile = 6
}

interface AutoModerationTriggerMetadata {
  keywordFilter?: string[];
  regexPatterns?: string[];
  presets?: KeywordPresetType[];
  allowList?: string[];
  mentionTotalLimit?: number;
  mentionRaidProtectionEnabled?: boolean;
}

enum KeywordPresetType {
  Profanity = 1,
  SexualContent = 2,
  Slurs = 3
}

interface AutoModerationAction {
  type: AutoModerationActionType;
  metadata?: {
    channelId?: string;
    durationSeconds?: number;
    customMessage?: string;
  };
}

enum AutoModerationActionType {
  BlockMessage = 1,
  SendAlertMessage = 2,
  Timeout = 3,
  BlockMemberInteraction = 4
}
```

## Core Functions

### `registerSlashCommands(...)`

#### Parameters

* `commands: SlashCommand[]`: Array of slash command definitions
* `guildId?: string`: Optional guild ID to register commands in (for testing)

#### Returns

* `Promise<void>`

#### Description

Registers slash commands with Discord. If `guildId` is provided, commands are registered as guild commands (instant update, up to 100). Otherwise, they're registered as global commands (up to 1 hour propagation, up to 100).

### `handleCommandInteraction(...)`

#### Parameters

* `interaction: CommandInteraction`: The command interaction to handle

#### Returns

* `Promise<void>`

#### Description

Routes command interactions to the appropriate handler. Built-in commands are handled internally; custom commands can be registered via the plugin system.

### `sendMessageWithComponents(...)`

#### Parameters

* `request: SendMessageRequest & { components: MessageComponent[] }`: Message with components

#### Returns

* `Promise<DiscordMessage>`

#### Description

Sends a message with interactive components (buttons, select menus). Handles component interactions automatically.

### `showModal(...)`

#### Parameters

* `interactionId: string`: The interaction token
* `modal: Modal`: The modal to display

#### Returns

* `Promise<void>`

#### Description

Shows a modal dialog in response to a component interaction or command.

### `createThread(...)`

#### Parameters

* `options: ThreadCreateOptions`: Thread creation options

#### Returns

* `Promise<DiscordChannel>`: The created thread channel

#### Description

Creates a new thread. Can be used to create forum posts, announcement threads, or regular threads.

### `setPresence(...)`

#### Parameters

* `presence: PresenceData`: Presence data to set

#### Returns

* `Promise<void>`

#### Description

Updates the bot's presence status and activity.

## Event Handling

The Discord adapter emits normalized events that map to the Social SDK interface:

| Discord Event | Social SDK Event | Description |
|:--------------|:-----------------|:------------|
| `messageCreate` | `message` | New message received |
| `messageUpdate` | `messageUpdate` | Message edited |
| `messageDelete` | `messageDelete` | Message deleted |
| `messageReactionAdd` | `reactionAdd` | Reaction added |
| `messageReactionRemove` | `reactionRemove` | Reaction removed |
| `interactionCreate` | `interaction` | Slash command or component interaction |
| `typingStart` | `typingStart` | User started typing |
| `channelCreate` | `channelCreate` | Channel created |
| `channelDelete` | `channelDelete` | Channel deleted |
| `guildMemberAdd` | `memberJoin` | Member joined guild |
| `guildMemberRemove` | `memberLeave` | Member left guild |
| `voiceStateUpdate` | `voiceStateChange` | Voice channel join/leave/move |

## Permissions

Discord permissions are represented as a bigint bitmask:

```typescript
enum Permissions {
  CreateInstantInvite = 1n << 0n,
  KickMembers = 1n << 1n,
  BanMembers = 1n << 2n,
  Administrator = 1n << 3n,
  ManageChannels = 1n << 4n,
  ManageGuild = 1n << 5n,
  AddReactions = 1n << 6n,
  ViewAuditLog = 1n << 7n,
  PrioritySpeaker = 1n << 8n,
  Stream = 1n << 9n,
  ViewChannel = 1n << 10n,
  SendMessages = 1n << 11n,
  SendTTSMessages = 1n << 12n,
  ManageMessages = 1n << 13n,
  EmbedLinks = 1n << 14n,
  AttachFiles = 1n << 15n,
  ReadMessageHistory = 1n << 16n,
  MentionEveryone = 1n << 17n,
  UseExternalEmojis = 1n << 18n,
  ViewGuildInsights = 1n << 19n,
  Connect = 1n << 20n,
  Speak = 1n << 21n,
  MuteMembers = 1n << 22n,
  DeafenMembers = 1n << 23n,
  MoveMembers = 1n << 24n,
  UseVAD = 1n << 25n,
  ChangeNickname = 1n << 26n,
  ManageNicknames = 1n << 27n,
  ManageRoles = 1n << 28n,
  ManageWebhooks = 1n << 29n,
  ManageGuildExpressions = 1n << 30n,
  UseApplicationCommands = 1n << 31n,
  RequestToSpeak = 1n << 32n,
  ManageEvents = 1n << 33n,
  ManageThreads = 1n << 34n,
  CreatePublicThreads = 1n << 35n,
  CreatePrivateThreads = 1n << 36n,
  UseExternalStickers = 1n << 37n,
  SendMessagesInThreads = 1n << 38n,
  UseEmbeddedActivities = 1n << 39n,
  ModerateMembers = 1n << 40n,
  ViewCreatorMonetizationAnalytics = 1n << 41n,
  UseSoundboard = 1n << 42n,
  CreateGuildExpressions = 1n << 43n,
  CreateEvents = 1n << 44n,
  UseExternalSounds = 1n << 45n,
  SendVoiceMessages = 1n << 46n,
  SendPolls = 1n << 49n,
  UseExternalApps = 1n << 50n
}
```

## Configuration

Discord-specific configuration via environment variables:

**Required:**
* `DISCORD_BOT_TOKEN`: Discord bot token from [Discord Developer Portal](https://discord.com/developers/applications)
* `DISCORD_CLIENT_ID`: Application client ID

**Optional:**
* `DISCORD_INTENTS`: Gateway intents as comma-separated list (default: `Guilds,GuildMessages,GuildMembers,GuildVoiceStates,GuildMessageReactions,GuildMessageTyping,DirectMessages,DirectMessageReactions,DirectMessageTyping,MessageContent`)
* `DISCORD_SHARD_COUNT`: Number of shards (default: auto)
* `DISCORD_SHARD_IDS`: Specific shard IDs to run (comma-separated)
* `DISCORD_PRESENCE_STATUS`: Default presence status (`online`, `idle`, `dnd`, `invisible`)
* `DISCORD_PRESENCE_ACTIVITY`: Default activity name
* `DISCORD_PRESENCE_ACTIVITY_TYPE`: Activity type (`playing`, `listening`, `watching`, `competing`, `streaming`)
* `DISCORD_STREAMING_URL`: Twitch/YouTube URL for streaming activity
* `DISCORD_COMMAND_GUILD_ID`: Guild ID for testing slash commands (instant update)
* `DISCORD_MESSAGE_CACHE_SIZE`: Maximum messages to cache per channel (default: 100)
* `DISCORD_DISABLE_MENTIONS`: Set to `true` to disable all mentions by default
* `DISCORD_ALLOWED_MENTIONS`: Allowed mention types (default: `roles,users,everyone`)

## Error Handling

Discord-specific error types extending [`PlatformError`](/specifications/social-sdk/social-sdk#error-handling):

```typescript
enum DiscordErrorType {
  // HTTP errors
  UnknownAccount = 10001,
  UnknownApplication = 10002,
  UnknownChannel = 10003,
  UnknownGuild = 10004,
  UnknownIntegration = 10005,
  UnknownInvite = 10006,
  UnknownMember = 10007,
  UnknownMessage = 10008,
  UnknownPermissionOverwrite = 10009,
  UnknownProvider = 10010,
  UnknownRole = 10011,
  UnknownToken = 10012,
  UnknownUser = 10013,
  UnknownEmoji = 10014,
  UnknownWebhook = 10015,
  UnknownBan = 10026,
  
  // General errors
  BotsCannotUse = 20001,
  OnlyBotsCanUse = 20002,
  CannotSendMessagesToUser = 50007,
  CannotSendMessagesInVoiceChannel = 50008,
  VerificationLevelTooHigh = 50009,
  OAuth2ApplicationLacksBot = 50010,
  OAuth2ApplicationLimitReached = 50011,
  InvalidOAuthState = 50012,
  MissingPermissions = 50013,
  InvalidAuthenticationToken = 50014,
  NoteTooLong = 50015,
  TooFewOrTooManyMessages = 50016,
  MessageCanOnlyBePinnedInChannelItWasSent = 50019,
  InviteCodeInvalidOrTaken = 50020,
  CannotExecuteOnSystemMessage = 50021,
  CannotExecuteOnChannelType = 50024,
  InvalidOAuthToken = 50025,
  MissingOAuthScope = 50026,
  InvalidWebhookToken = 50027,
  InvalidRole = 50028,
  InvalidRecipient = 50033,
  MessageTooOldToBulkDelete = 50034,
  InvalidFormBody = 50035,
  InviteAcceptedToGuildBotNotIn = 50036,
  InvalidActivityAction = 50039,
  InvalidAPIVersion = 50041,
  FileTooLarge = 50045,
  InvalidFileUploaded = 50046,
  CannotSelfRedeemGift = 50054,
  InvalidGuild = 50055,
  PaymentSourceRequired = 50070,
  CannotDeleteCommunityRequiredChannel = 50074,
  InvalidStickerSent = 50081,
  ThreadArchived = 50083,
  InvalidThreadNotificationSettings = 50084,
  ParameterEarlierThanCreation = 50085,
  GuildNotAvailableInLocation = 50095,
  GuildMonetizationRequired = 50097,
  
  // Rate limits
  RateLimited = 429,
  
  // Gateway errors
  DisallowedGatewayIntent = 4014,
  DisallowedGatewayIntentPrivileged = 4013
}
```

## Integration with Social SDK

The Discord adapter implements the [`SocialPlatform`](/specifications/social-sdk/social-sdk#socialplatform-interface) interface:

| Social SDK Method | Discord Implementation |
|:------------------|:-----------------------|
| `sendMessage` | Uses `TextChannel.send()` |
| `sendDM` | Creates DM channel via `User.createDM()` then sends |
| `addReaction` | Uses `Message.react()` |
| `joinVoiceChannel` | See [Voice Calls](/specifications/social-sdk/discord/voice-call) |
| `getChannel` | Uses `Client.channels.fetch()` |
| `getUser` | Uses `Client.users.fetch()` |

All capabilities are set to `true` except where Discord limitations apply.
