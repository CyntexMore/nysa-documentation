---
title: Discord統合
description: Nysaの公式Discord統合の仕様です。
---

import { Steps, Card } from '@astrojs/starlight/components';

Discord統合は、[Discord.js](https://discord.js.org/)をベースに構築されたNysaのファーストクラスアダプターです。スラッシュコマンド、メッセージインタラクション、スレッド、リアクション、ボイスコール、モデレーションツールなど、すべてのDiscord機能を包括的にサポートしています。

このアダプターは、高度なユースケース向けにDiscord固有の機能を公開しながら、[`SocialPlatform`](/specifications/social-sdk/social-sdk#socialplatform-interface)インターフェースを実装しています。

## ボイスコール

音声パイプライン、Opusトランスコーディング、Whisper統合、TTSセットアップを含むボイスコールの仕様については、[Discordボイスコール](/specifications/social-sdk/discord/voice-call)仕様を参照してください。

## ユーザー識別

DiscordユーザーIDは、Nysaにおけるユーザーの**正規識別子**です。ユーザー名（変更可能）、表示名（変更可能）、または識別子（削除済み）とは異なり、ユーザーIDは同じアカウントを常に識別する永続的で一意なスノーフレークです。

### なぜユーザーIDなのか？

* **永続性**: ユーザーがユーザー名、表示名、アバター、その他のプロファイル属性を変更しても、ユーザーIDは変更されません
* **一意性**: 各Discordアカウントは正確に1つの一意なIDを持ちます（例：`686175431539556565`）
* **メモリ統合**: nmgineメモリの[`userId`](/specifications/memory-engine#memory-object)フィールドには、信頼性の高いセッション横断識別のためにDiscordユーザーIDを保存する必要があります
* **メンション解決**: ユーザーIDはDiscordのメンション形式（`<@686175431539556565>`）で使用され、常に現在のユーザープロファイルに解決できます

### ユーザーID形式

DiscordユーザーIDは17～20桁のスノーフレークです：

```typescript
// ユーザーIDの例
const userId = "686175431539556565"; // 常に文字列で、数値ではない（精度損失防止）

// Discord.jsからのアクセス
const userId = message.author.id;        // "686175431539556565"
const userId = interaction.user.id;      // "686175431539556565"
const userId = guildMember.id;           // "686175431539556565"
```

### nmgineでの保存

Discordユーザーに関連付けられたメモリを保存する場合は、常にDiscordユーザーIDを使用してください：

```typescript
interface Memory {
  id: number;
  userId: ["686175431539556565"]; // DiscordユーザーID
  shortName: string;
  type: MemoryType;
  content: string;
  // ...
}
```

これにより、ユーザーがユーザー名を`johndoe`から`janesmith`に変更しても、Nysaは引き続きユーザーを認識し、関連するメモリを正しく取得できます。

## アーキテクチャ

Discordアダプターはレイヤー化されたアーキテクチャに従います：

1. **ゲートウェイレイヤー**: リアルタイムイベント用のDiscordゲートウェイへのWebSocket接続
2. **RESTレイヤー**: メッセージ送信、チャンネル管理などのためのHTTP APIクライアント
3. **コマンドレイヤー**: スラッシュコマンドの登録、処理、およびオートコンプリート
4. **イベントレイヤー**: メッセージ、リアクション、インタラクションの正規化されたイベント処理
5. **ボイスレイヤー**: ボイス接続管理（[ボイスコール](/specifications/social-sdk/discord/voice-call)を参照）

## データモデル

### DiscordMessage

[`PlatformMessage`](/specifications/social-sdk/social-sdk#platformmessage)をDiscord固有のフィールドで拡張します：

```typescript
interface DiscordMessage extends PlatformMessage {
  // Discord固有のフィールド
  type: MessageType;
  flags: MessageFlags;
  mentionEveryone: boolean;
  mentionRoles: string[];
  pinned: boolean;
  webhookId?: string;
  applicationId?: string;
  activity?: MessageActivity;
  
  // インタラクションコンテキスト
  interaction?: {
    id: string;
    type: InteractionType;
    name: string;
    user: PlatformUser;
  };
  
  // スレッド開始者
  thread?: DiscordChannel; // このメッセージがスレッドを開始した場合
  
  // このメッセージと共に送信されたコンポーネント（ボタン、セレクト）
  components?: MessageComponent[];
}

enum MessageType {
  Default = 0,
  RecipientAdd = 1,
  RecipientRemove = 2,
  Call = 3,
  ChannelNameChange = 4,
  ChannelIconChange = 5,
  ChannelPinnedMessage = 6,
  UserJoin = 7,
  GuildBoost = 8,
  GuildBoostTier1 = 9,
  GuildBoostTier2 = 10,
  GuildBoostTier3 = 11,
  ChannelFollowAdd = 12,
  GuildDiscoveryDisqualified = 14,
  GuildDiscoveryRequalified = 15,
  GuildDiscoveryGracePeriodInitialWarning = 16,
  GuildDiscoveryGracePeriodFinalWarning = 17,
  ThreadCreated = 18,
  Reply = 19,
  ChatInputCommand = 20,
  ThreadStarterMessage = 21,
  GuildInviteReminder = 22,
  ContextMenuCommand = 23,
  AutoModerationAction = 24,
  RoleSubscriptionPurchase = 25,
  InteractionPremiumUpsell = 26,
  StageStart = 27,
  StageEnd = 28,
  StageSpeaker = 29,
  StageTopic = 31,
  GuildApplicationPremiumSubscription = 32
}

enum MessageFlags {
  Crossposted = 1 << 0,
  IsCrosspost = 1 << 1,
  SuppressEmbeds = 1 << 2,
  SourceMessageDeleted = 1 << 3,
  Urgent = 1 << 4,
  HasThread = 1 << 5,
  Ephemeral = 1 << 6,
  Loading = 1 << 7,
  FailedToMentionSomeRolesInThread = 1 << 8,
  SuppressNotifications = 1 << 12,
  IsVoiceMessage = 1 << 13
}

interface MessageActivity {
  type: MessageActivityType;
  partyId?: string;
}

enum MessageActivityType {
  Join = 1,
  Spectate = 2,
  Listen = 3,
  JoinRequest = 5
}
```

### DiscordUser

[`PlatformUser`](/specifications/social-sdk/social-sdk#platformuser)をDiscord固有のフィールドで拡張します：

```typescript
interface DiscordUser extends PlatformUser {
  discriminator: string; // レガシー識別子（例："1234"）
  globalName?: string;   // 表示名（新しいユーザー名システム）
  bannerUrl?: string;
  accentColor?: number;
  locale?: string;
  verified?: boolean;
  email?: string;        // OAuth2スコープが必要
  flags: UserFlags;
  premiumType: PremiumType;
  publicFlags: UserFlags;
}

enum UserFlags {
  Staff = 1 << 0,
  Partner = 1 << 1,
  HypeSquad = 1 << 2,
  BugHunterLevel1 = 1 << 3,
  HypeSquadOnlineHouse1 = 1 << 6,
  HypeSquadOnlineHouse2 = 1 << 7,
  HypeSquadOnlineHouse3 = 1 << 8,
  PremiumEarlySupporter = 1 << 9,
  TeamPseudoUser = 1 << 10,
  BugHunterLevel2 = 1 << 14,
  VerifiedBot = 1 << 16,
  VerifiedDeveloper = 1 << 17,
  CertifiedModerator = 1 << 18,
  BotHTTPInteractions = 1 << 19,
  ActiveDeveloper = 1 << 22
}

enum PremiumType {
  None = 0,
  NitroClassic = 1,
  Nitro = 2,
  NitroBasic = 3
}
```

### DiscordGuild

```typescript
interface DiscordGuild {
  id: string;
  name: string;
  iconUrl?: string;
  splashUrl?: string;
  discoverySplashUrl?: string;
  ownerId: string;
  afkChannelId?: string;
  afkTimeout: number;
  widgetEnabled?: boolean;
  widgetChannelId?: string;
  verificationLevel: VerificationLevel;
  defaultMessageNotifications: MessageNotificationLevel;
  explicitContentFilter: ExplicitContentFilterLevel;
  roles: DiscordRole[];
  emojis: DiscordEmoji[];
  features: GuildFeature[];
  mfaLevel: MFALevel;
  systemChannelId?: string;
  systemChannelFlags: SystemChannelFlags;
  rulesChannelId?: string;
  maxPresences?: number;
  maxMembers?: number;
  vanityUrlCode?: string;
  description?: string;
  bannerUrl?: string;
  premiumTier: PremiumTier;
  premiumSubscriptionCount?: number;
  preferredLocale: string;
  publicUpdatesChannelId?: string;
  maxVideoChannelUsers?: number;
  maxStageVideoChannelUsers?: number;
  approximateMemberCount?: number;
  approximatePresenceCount?: number;
  welcomeScreen?: WelcomeScreen;
  nsfwLevel: GuildNSFWLevel;
  stickers: DiscordSticker[];
}

enum VerificationLevel {
  None = 0,
  Low = 1,
  Medium = 2,
  High = 3,
  VeryHigh = 4
}

enum MessageNotificationLevel {
  AllMessages = 0,
  OnlyMentions = 1
}

enum ExplicitContentFilterLevel {
  Disabled = 0,
  MembersWithoutRoles = 1,
  AllMembers = 2
}

enum MFALevel {
  None = 0,
  Elevated = 1
}

enum PremiumTier {
  None = 0,
  Tier1 = 1,
  Tier2 = 2,
  Tier3 = 3
}

enum GuildNSFWLevel {
  Default = 0,
  Explicit = 1,
  Safe = 2,
  AgeRestricted = 3
}

type GuildFeature = 
  | "ANIMATED_BANNER"
  | "ANIMATED_ICON"
  | "APPLICATION_COMMAND_PERMISSIONS_V2"
  | "AUTO_MODERATION"
  | "BANNER"
  | "COMMUNITY"
  | "CREATOR_MONETIZABLE_PROVISIONAL"
  | "CREATOR_STORE_PAGE"
  | "DEVELOPER_SUPPORT_SERVER"
  | "DISCOVERABLE"
  | "FEATURABLE"
  | "INVITES_DISABLED"
  | "INVITE_SPLASH"
  | "MEMBER_VERIFICATION_GATE_ENABLED"
  | "MORE_STICKERS"
  | "NEWS"
  | "PARTNERED"
  | "PREVIEW_ENABLED"
  | "RAID_ALERTS_DISABLED"
  | "ROLE_ICONS"
  | "ROLE_SUBSCRIPTIONS_AVAILABLE_FOR_PURCHASE"
  | "ROLE_SUBSCRIPTIONS_ENABLED"
  | "TICKETED_EVENTS_ENABLED"
  | "VANITY_URL"
  | "VERIFIED"
  | "VIP_REGIONS"
  | "WELCOME_SCREEN_ENABLED";
```

### DiscordChannel

[`PlatformChannel`](/specifications/social-sdk/social-sdk#platformchannel)をDiscord固有のフィールドで拡張します：

```typescript
interface DiscordChannel extends PlatformChannel {
  // Discord固有のタイプ
  type: DiscordChannelType;
  
  // ギルドチャンネル
  guildId?: string;
  permissionOverwrites: PermissionOverwrite[];
  
  // テキストチャンネル
  topic?: string;
  lastMessageId?: string;
  lastPinTimestamp?: Date;
  defaultAutoArchiveDuration?: number; // スレッド自動アーカイブ（分単位）
  
  // ボイス/ステージチャンネル
  bitrate?: number;
  userLimit?: number;
  rtcRegion?: string;
  videoQualityMode?: VideoQualityMode;
  
  // フォーラムチャンネル
  availableTags?: ForumTag[];
  defaultReactionEmoji?: DefaultReactionEmoji;
  defaultThreadRateLimitPerUser?: number;
  defaultSortOrder?: SortOrderType;
  defaultForumLayout?: ForumLayoutType;
  
  // スレッド固有
  messageCount?: number;
  memberCount?: number;
  archived?: boolean;
  archiverId?: string;
  autoArchiveDuration?: number;
  locked?: boolean;
  invitable?: boolean;
  appliedTags?: string[]; // フォーラム投稿タグ
}

enum DiscordChannelType {
  GuildText = 0,
  DM = 1,
  GuildVoice = 2,
  GroupDM = 3,
  GuildCategory = 4,
  GuildAnnouncement = 5,
  AnnouncementThread = 10,
  PublicThread = 11,
  PrivateThread = 12,
  GuildStageVoice = 13,
  GuildDirectory = 14,
  GuildForum = 15,
  GuildMedia = 16
}

enum VideoQualityMode {
  Auto = 1,
  Full = 2
}

enum SortOrderType {
  LatestActivity = 0,
  CreationDate = 1
}

enum ForumLayoutType {
  NotSet = 0,
  ListView = 1,
  GalleryView = 2
}

interface PermissionOverwrite {
  id: string;
  type: "role" | "member";
  allow: bigint; // 権限フラグ
  deny: bigint;  // 権限フラグ
}

interface ForumTag {
  id: string;
  name: string;
  moderated: boolean;
  emojiId?: string;
  emojiName?: string;
}

interface DefaultReactionEmoji {
  emojiId?: string;
  emojiName?: string;
}
```

### DiscordRole

```typescript
interface DiscordRole {
  id: string;
  name: string;
  color: number;
  hoist: boolean;
  iconUrl?: string;
  unicodeEmoji?: string;
  position: number;
  permissions: bigint;
  managed: boolean;
  mentionable: boolean;
  tags?: RoleTags;
}

interface RoleTags {
  botId?: string;
  integrationId?: string;
  premiumSubscriber?: boolean; // APIではnull、Nitroブースターロールを示す
  subscriptionListingId?: string;
  availableForPurchase?: boolean;
  guildConnections?: boolean;
}
```

### DiscordEmoji

```typescript
interface DiscordEmoji {
  id: string; // Unicode絵文字の場合はnull
  name: string;
  roles?: string[];
  user?: DiscordUser;
  requireColons?: boolean;
  managed?: boolean;
  animated?: boolean;
  available?: boolean;
}
```

## スラッシュコマンド

スラッシュコマンドは、ユーザーがNysaと対話するための構造化された方法を提供します。`/`と入力すると表示され、オートコンプリート、検証、明確なドキュメントを提供します。

### コマンド登録

```typescript
interface SlashCommand {
  name: string;
  nameLocalizations?: Record<string, string>;
  description: string;
  descriptionLocalizations?: Record<string, string>;
  options?: CommandOption[];
  defaultMemberPermissions?: bigint;
  dmPermission?: boolean;
  defaultPermission?: boolean; // 非推奨
  nsfw?: boolean;
  integrationTypes?: ApplicationIntegrationType[];
  contexts?: InteractionContextType[];
}

type CommandOption = 
  | StringOption
  | IntegerOption
  | NumberOption
  | BooleanOption
  | UserOption
  | ChannelOption
  | RoleOption
  | MentionableOption
  | AttachmentOption;

interface BaseOption {
  name: string;
  nameLocalizations?: Record<string, string>;
  description: string;
  descriptionLocalizations?: Record<string, string>;
  required?: boolean;
}

interface StringOption extends BaseOption {
  type: ApplicationCommandOptionType.String;
  choices?: CommandChoice[];
  autocomplete?: boolean;
  minLength?: number;
  maxLength?: number;
}

interface IntegerOption extends BaseOption {
  type: ApplicationCommandOptionType.Integer;
  choices?: CommandChoice[];
  autocomplete?: boolean;
  minValue?: number;
  maxValue?: number;
}

interface NumberOption extends BaseOption {
  type: ApplicationCommandOptionType.Number;
  choices?: CommandChoice[];
  autocomplete?: boolean;
  minValue?: number;
  maxValue?: number;
}

interface BooleanOption extends BaseOption {
  type: ApplicationCommandOptionType.Boolean;
}

interface UserOption extends BaseOption {
  type: ApplicationCommandOptionType.User;
}

interface ChannelOption extends BaseOption {
  type: ApplicationCommandOptionType.Channel;
  channelTypes?: ChannelType[];
}

interface RoleOption extends BaseOption {
  type: ApplicationCommandOptionType.Role;
}

interface MentionableOption extends BaseOption {
  type: ApplicationCommandOptionType.Mentionable;
}

interface AttachmentOption extends BaseOption {
  type: ApplicationCommandOptionType.Attachment;
}

interface CommandChoice {
  name: string;
  nameLocalizations?: Record<string, string>;
  value: string | number;
}

enum ApplicationCommandOptionType {
  SubCommand = 1,
  SubCommandGroup = 2,
  String = 3,
  Integer = 4,
  Boolean = 5,
  User = 6,
  Channel = 7,
  Role = 8,
  Mentionable = 9,
  Number = 10,
  Attachment = 11
}

enum ApplicationIntegrationType {
  GuildInstall = 0,
  UserInstall = 1
}

enum InteractionContextType {
  Guild = 0,
  BotDM = 1,
  PrivateChannel = 2
}
```

### 組み込みコマンド

Nysaはデフォルトで以下のコマンドを登録する必要があります：

| コマンド | 説明 | オプション |
|:--------|:------------|:--------|
| `/talk` | Nysaとの会話を開始する | `topic`（文字列、オプション）：話すトピック |
| `/remember` | 事実をメモリに保存する | `fact`（文字列、必須）：記憶する事実 |
| `/forget` | メモリから事実を削除する | `fact`（文字列、オートコンプリート）：削除する事実 |
| `/voice join` | 現在のボイスチャンネルに参加する | - |
| `/voice leave` | ボイスチャンネルから退出する | - |
| `/persona` | Nysaの人格を変更する | `name`（文字列、オートコンプリート）：読み込むペルソナ |
| `/status` | Nysaのシステムステータスを確認する | - |
| `/help` | 利用可能なコマンドを表示する | `command`（文字列、オプション）：特定のコマンドヘルプ |

### コマンド処理

```typescript
interface CommandInteraction {
  id: string;
  applicationId: string;
  type: InteractionType.ApplicationCommand;
  data: CommandInteractionData;
  guildId?: string;
  channel?: DiscordChannel;
  channelId?: string;
  member?: GuildMember;
  user: DiscordUser;
  token: string;
  version: number;
  message?: DiscordMessage; // メッセージコマンド用
  appPermissions?: bigint;
  locale: string;
  guildLocale?: string;
  entitlements: Entitlement[];
  authorizingIntegrationOwners: Record<ApplicationIntegrationType, string>;
  context?: InteractionContextType;
}

interface CommandInteractionData {
  id: string;
  name: string;
  type: ApplicationCommandType;
  resolved?: ResolvedData;
  options?: CommandInteractionOption[];
  guildId?: string;
  targetId?: string; // ユーザー/メッセージコマンド用
}

interface CommandInteractionOption {
  name: string;
  type: ApplicationCommandOptionType;
  value?: string | number | boolean;
  options?: CommandInteractionOption[];
  focused?: boolean; // オートコンプリート用
}

enum InteractionType {
  Ping = 1,
  ApplicationCommand = 2,
  MessageComponent = 3,
  ApplicationCommandAutocomplete = 4,
  ModalSubmit = 5
}

enum ApplicationCommandType {
  ChatInput = 1,
  User = 2,
  Message = 3
}
```

### オートコンプリート

`autocomplete: true`のコマンドについて、Nysaはユーザー入力時に候補を提供します：

```typescript
interface AutocompleteInteraction {
  id: string;
  applicationId: string;
  type: InteractionType.ApplicationCommandAutocomplete;
  data: AutocompleteData;
  guildId?: string;
  channelId?: string;
  channel?: DiscordChannel;
  member?: GuildMember;
  user: DiscordUser;
  token: string;
  version: number;
  appPermissions?: bigint;
  locale: string;
  guildLocale?: string;
}

interface AutocompleteData {
  id: string;
  name: string;
  type: ApplicationCommandType.ChatInput;
  options: AutocompleteOption[];
}

interface AutocompleteOption {
  name: string;
  type: ApplicationCommandOptionType;
  value: string | number;
  focused: boolean;
}

// レスポンス形式
interface AutocompleteResponse {
  choices: AutocompleteChoice[];
}

interface AutocompleteChoice {
  name: string;
  nameLocalizations?: Record<string, string>;
  value: string | number;
}
```

## メッセージコンポーネント

Discordは、メッセージに添付できるインタラクティブコンポーネントをサポートしています：

### ボタン

```typescript
interface ButtonComponent {
  type: ComponentType.Button;
  style: ButtonStyle;
  label?: string;
  emoji?: PartialEmoji;
  customId?: string;
  url?: string;
  disabled?: boolean;
  skuId?: string; // プレミアムボタン用
}

enum ButtonStyle {
  Primary = 1,    // ブラープル
  Secondary = 2,  // グレー
  Success = 3,    // グリーン
  Danger = 4,     // レッド
  Link = 5,       // リンクアイコン付きグレー
  Premium = 6     // プレミアム（sku_idが必要）
}
```

### セレクトメニュー

```typescript
interface StringSelectComponent {
  type: ComponentType.StringSelect;
  customId: string;
  options: SelectOption[];
  placeholder?: string;
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface SelectOption {
  label: string;
  value: string;
  description?: string;
  emoji?: PartialEmoji;
  default?: boolean;
}

interface UserSelectComponent {
  type: ComponentType.UserSelect;
  customId: string;
  placeholder?: string;
  defaultValues?: SelectDefaultValue[];
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface RoleSelectComponent {
  type: ComponentType.RoleSelect;
  customId: string;
  placeholder?: string;
  defaultValues?: SelectDefaultValue[];
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface MentionableSelectComponent {
  type: ComponentType.MentionableSelect;
  customId: string;
  placeholder?: string;
  defaultValues?: SelectDefaultValue[];
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface ChannelSelectComponent {
  type: ComponentType.ChannelSelect;
  customId: string;
  placeholder?: string;
  defaultValues?: SelectDefaultValue[];
  channelTypes?: ChannelType[];
  minValues?: number;
  maxValues?: number;
  disabled?: boolean;
}

interface SelectDefaultValue {
  id: string;
  type: "user" | "role" | "channel";
}

enum ComponentType {
  ActionRow = 1,
  Button = 2,
  StringSelect = 3,
  TextInput = 4,
  UserSelect = 5,
  RoleSelect = 6,
  MentionableSelect = 7,
  ChannelSelect = 8
}

interface PartialEmoji {
  id?: string;
  name?: string;
  animated?: boolean;
}
```

### テキスト入力（モーダル）

```typescript
interface TextInputComponent {
  type: ComponentType.TextInput;
  customId: string;
  style: TextInputStyle;
  label: string;
  minLength?: number;
  maxLength?: number;
  required?: boolean;
  value?: string;
  placeholder?: string;
}

enum TextInputStyle {
  Short = 1,      // 単一行
  Paragraph = 2   // 複数行
}

interface Modal {
  customId: string;
  title: string;
  components: ActionRowComponent[]; // テキスト入力のみ、最大5つ
}

interface ActionRowComponent {
  type: ComponentType.ActionRow;
  components: TextInputComponent[];
}
```

## スレッド

Discordスレッドはファーストクラスオブジェクトとしてサポートされています：

```typescript
interface ThreadManager {
  // スレッドを作成する
  create(options: ThreadCreateOptions): Promise<DiscordChannel>;
  
  // スレッドに参加する
  join(threadId: string): Promise<void>;
  
  // スレッドから退出する
  leave(threadId: string): Promise<void>;
  
  // スレッドをアーカイブする
  archive(threadId: string, locked?: boolean): Promise<void>;
  
  // スレッドをアンアーカイブする
  unarchive(threadId: string): Promise<void>;
  
  // スレッドを削除する
  delete(threadId: string): Promise<void>;
  
  // メンバーをプライベートスレッドに追加する
  addMember(threadId: string, userId: string): Promise<void>;
  
  // メンバーをスレッドから削除する
  removeMember(threadId: string, userId: string): Promise<void>;
  
  // スレッドメンバーを取得する
  getMembers(threadId: string): Promise<ThreadMember[]>;
  
  // アクティブなスレッドを一覧表示する
  fetchActive(guildId?: string): Promise<DiscordChannel[]>;
  
  // アーカイブされたスレッドを一覧表示する
  fetchArchived(options?: FetchArchivedOptions): Promise<{
    threads: DiscordChannel[];
    members: ThreadMember[];
    hasMore: boolean;
  }>;
}

interface ThreadCreateOptions {
  name: string;
  autoArchiveDuration: 60 | 1440 | 4320 | 10080; // 分単位（1時間、24時間、3日、7日）
  rateLimitPerUser?: number;
  message?: SendMessageRequest; // 開始メッセージ
  invitable?: boolean; // プライベートスレッドのみ
  type?: ChannelType.PublicThread | ChannelType.PrivateThread | ChannelType.AnnouncementThread;
  appliedTags?: string[]; // フォーラムタグ
}

interface ThreadMember {
  id?: string;
  userId?: string;
  joinTimestamp: Date;
  flags: number;
  member?: GuildMember;
}

interface FetchArchivedOptions {
  type?: "public" | "private";
  before?: string; // スノーフレーク
  limit?: number;
}
```

## リアクション

```typescript
interface ReactionManager {
  // リアクションを追加する
  add(messageId: string, channelId: string, emoji: string): Promise<void>;
  
  // ボットのリアクションを削除する
  removeOwn(messageId: string, channelId: string, emoji: string): Promise<void>;
  
  // ユーザーのリアクションを削除する
  removeUser(messageId: string, channelId: string, emoji: string, userId: string): Promise<void>;
  
  // すべてのリアクションを削除する
  removeAll(messageId: string, channelId: string): Promise<void>;
  
  // 特定の絵文字のリアクションをすべて削除する
  removeEmoji(messageId: string, channelId: string, emoji: string): Promise<void>;
  
  // 絵文字でリアクションしたユーザーを取得する
  fetchUsers(messageId: string, channelId: string, emoji: string, options?: {
    limit?: number;
    after?: string;
  }): Promise<DiscordUser[]>;
}
```

## ギルド管理

```typescript
interface GuildManager {
  // ギルドを取得する
  fetch(guildId: string): Promise<DiscordGuild>;
  
  // ギルドから退出する
  leave(guildId: string): Promise<void>;
  
  // ギルドプレビューを取得する（メンバー以外用）
  fetchPreview(guildId: string): Promise<GuildPreview>;
  
  // ユーザーをBANする
  ban(guildId: string, userId: string, options?: BanOptions): Promise<void>;
  
  // ユーザーのBANを解除する
  unban(guildId: string, userId: string, reason?: string): Promise<void>;
  
  // メンバーをキックする
  kick(guildId: string, userId: string, reason?: string): Promise<void>;
  
  // BAN一覧を取得する
  fetchBans(guildId: string, options?: { limit?: number; before?: string; after?: string }): Promise<Ban[]>;
  
  // 監査ログを取得する
  fetchAuditLogs(guildId: string, options?: AuditLogOptions): Promise<AuditLog>;
  
  // ギルドウィジェットを取得する
  fetchWidget(guildId: string): Promise<GuildWidget>;
  
  // ギルドウィジェット設定を取得する
  fetchWidgetSettings(guildId: string): Promise<GuildWidgetSettings>;
}

interface BanOptions {
  deleteMessageSeconds?: number; // 直近N秒間のメッセージを削除（0-604800）
  reason?: string;
}

interface Ban {
  reason?: string;
  user: DiscordUser;
}

interface AuditLogOptions {
  userId?: string;
  actionType?: AuditLogEvent;
  before?: string;
  after?: string;
  limit?: number;
}

enum AuditLogEvent {
  GuildUpdate = 1,
  ChannelCreate = 10,
  ChannelUpdate = 11,
  ChannelDelete = 12,
  ChannelOverwriteCreate = 13,
  ChannelOverwriteUpdate = 14,
  ChannelOverwriteDelete = 15,
  MemberKick = 20,
  MemberPrune = 21,
  MemberBanAdd = 22,
  MemberBanRemove = 23,
  MemberUpdate = 24,
  MemberRoleUpdate = 25,
  MemberMove = 26,
  MemberDisconnect = 27,
  BotAdd = 28,
  RoleCreate = 30,
  RoleUpdate = 31,
  RoleDelete = 32,
  InviteCreate = 40,
  InviteUpdate = 41,
  InviteDelete = 42,
  WebhookCreate = 50,
  WebhookUpdate = 51,
  WebhookDelete = 52,
  EmojiCreate = 60,
  EmojiUpdate = 61,
  EmojiDelete = 62,
  MessageDelete = 72,
  MessageBulkDelete = 73,
  MessagePin = 74,
  MessageUnpin = 75,
  IntegrationCreate = 80,
  IntegrationUpdate = 81,
  IntegrationDelete = 82,
  StageInstanceCreate = 83,
  StageInstanceUpdate = 84,
  StageInstanceDelete = 85,
  StickerCreate = 90,
  StickerUpdate = 91,
  StickerDelete = 92,
  GuildScheduledEventCreate = 100,
  GuildScheduledEventUpdate = 101,
  GuildScheduledEventDelete = 102,
  ThreadCreate = 110,
  ThreadUpdate = 111,
  ThreadDelete = 112,
  ApplicationCommandPermissionUpdate = 121,
  AutoModerationRuleCreate = 140,
  AutoModerationRuleUpdate = 141,
  AutoModerationRuleDelete = 142,
  AutoModerationBlockMessage = 143,
  AutoModerationFlagToChannel = 144,
  AutoModerationUserCommunicationDisabled = 145,
  CreatorMonetizationRequestCreated = 150,
  CreatorMonetizationTermsAccepted = 151,
  OnboardingPromptCreate = 163,
  OnboardingPromptUpdate = 164,
  OnboardingPromptDelete = 165,
  OnboardingCreate = 166,
  OnboardingUpdate = 167,
  HomeSettingsCreate = 190,
  HomeSettingsUpdate = 191
}
```

## プレゼンスとリッチプレゼンス

```typescript
interface PresenceManager {
  // ボットのプレゼンスを設定する
  set(presence: PresenceData): Promise<void>;
  
  // プレゼンスをクリアする
  clear(): Promise<void>;
}

interface PresenceData {
  status?: "online" | "idle" | "dnd" | "invisible" | "offline";
  afk?: boolean;
  activities?: Activity[];
  since?: number | null;
}

interface Activity {
  name: string;
  type: ActivityType;
  url?: string;
  createdAt: number;
  timestamps?: ActivityTimestamps;
  applicationId?: string;
  details?: string;
  state?: string;
  emoji?: ActivityEmoji;
  party?: ActivityParty;
  assets?: ActivityAssets;
  secrets?: ActivitySecrets;
  instance?: boolean;
  flags?: ActivityFlags;
  buttons?: ActivityButton[];
}

enum ActivityType {
  Playing = 0,
  Streaming = 1,
  Listening = 2,
  Watching = 3,
  Custom = 4,
  Competing = 5
}

interface ActivityTimestamps {
  start?: number;
  end?: number;
}

interface ActivityEmoji {
  name: string;
  id?: string;
  animated?: boolean;
}

interface ActivityParty {
  id?: string;
  size?: [current: number, max: number];
}

interface ActivityAssets {
  largeImage?: string;
  largeText?: string;
  smallImage?: string;
  smallText?: string;
}

interface ActivitySecrets {
  join?: string;
  spectate?: string;
  match?: string;
}

enum ActivityFlags {
  Instance = 1 << 0,
  Join = 1 << 1,
  Spectate = 1 << 2,
  JoinRequest = 1 << 3,
  Sync = 1 << 4,
  Play = 1 << 5,
  PartyPrivacyFriends = 1 << 6,
  PartyPrivacyVoiceChannel = 1 << 7,
  Embedded = 1 << 8
}

interface ActivityButton {
  label: string;
  url: string;
}
```

## Webhook

```typescript
interface WebhookManager {
  // Webhookを作成する
  create(channelId: string, options: WebhookCreateOptions): Promise<Webhook>;
  
  // チャンネル内のWebhookを取得する
  fetchChannelWebhooks(channelId: string): Promise<Webhook[]>;
  
  // ギルド内のWebhookを取得する
  fetchGuildWebhooks(guildId: string): Promise<Webhook[]>;
  
  // 特定のWebhookを取得する
  fetch(webhookId: string, token?: string): Promise<Webhook>;
  
  // Webhookを編集する
  edit(webhookId: string, options: WebhookEditOptions, token?: string): Promise<Webhook>;
  
  // Webhookを削除する
  delete(webhookId: string, token?: string): Promise<void>;
  
  // Webhook経由でメッセージを送信する
  send(webhookId: string, token: string, message: WebhookMessage): Promise<DiscordMessage>;
}

interface Webhook {
  id: string;
  type: WebhookType;
  guildId?: string;
  channelId?: string;
  user?: DiscordUser;
  name: string;
  avatar?: string;
  token?: string;
  applicationId?: string;
  sourceGuild?: DiscordGuild;
  sourceChannel?: DiscordChannel;
  url?: string;
}

enum WebhookType {
  Incoming = 1,
  ChannelFollower = 2,
  Application = 3
}

interface WebhookCreateOptions {
  name: string;
  avatar?: Buffer | string; // Bufferまたはbase64データURI
  reason?: string;
}

interface WebhookEditOptions {
  name?: string;
  avatar?: Buffer | string | null;
  channel?: string; // 別のチャンネルに移動
  reason?: string;
}

interface WebhookMessage extends Omit<SendMessageRequest, "channelId"> {
  username?: string; // Webhook名を上書き
  avatarUrl?: string; // Webhookアバターを上書き
  threadId?: string; // スレッドに送信
}
```

## 自動モデレーション

```typescript
interface AutoModerationManager {
  // ルールを一覧表示する
  fetchRules(guildId: string): Promise<AutoModerationRule[]>;
  
  // ルールを取得する
  fetchRule(guildId: string, ruleId: string): Promise<AutoModerationRule>;
  
  // ルールを作成する
  createRule(guildId: string, options: AutoModerationRuleCreateOptions): Promise<AutoModerationRule>;
  
  // ルールを編集する
  editRule(guildId: string, ruleId: string, options: AutoModerationRuleEditOptions): Promise<AutoModerationRule>;
  
  // ルールを削除する
  deleteRule(guildId: string, ruleId: string, reason?: string): Promise<void>;
}

interface AutoModerationRule {
  id: string;
  guildId: string;
  name: string;
  creatorId: string;
  eventType: AutoModerationEventType;
  triggerType: AutoModerationTriggerType;
  triggerMetadata: AutoModerationTriggerMetadata;
  actions: AutoModerationAction[];
  enabled: boolean;
  exemptRoles: string[];
  exemptChannels: string[];
}

enum AutoModerationEventType {
  MessageSend = 1
}

enum AutoModerationTriggerType {
  Keyword = 1,
  Spam = 3,
  KeywordPreset = 4,
  MentionSpam = 5,
  MemberProfile = 6
}

interface AutoModerationTriggerMetadata {
  keywordFilter?: string[];
  regexPatterns?: string[];
  presets?: KeywordPresetType[];
  allowList?: string[];
  mentionTotalLimit?: number;
  mentionRaidProtectionEnabled?: boolean;
}

enum KeywordPresetType {
  Profanity = 1,
  SexualContent = 2,
  Slurs = 3
}

interface AutoModerationAction {
  type: AutoModerationActionType;
  metadata?: {
    channelId?: string;
    durationSeconds?: number;
    customMessage?: string;
  };
}

enum AutoModerationActionType {
  BlockMessage = 1,
  SendAlertMessage = 2,
  Timeout = 3,
  BlockMemberInteraction = 4
}
```

## コア関数

### `registerSlashCommands(...)`

#### パラメータ

* `commands: SlashCommand[]`: スラッシュコマンド定義の配列
* `guildId?: string`: コマンドを登録するオプションのギルドID（テスト用）

#### 戻り値

* `Promise<void>`

#### 説明

Discordにスラッシュコマンドを登録します。`guildId`が指定されている場合、コマンドはギルドコマンドとして登録されます（即時更新、最大100個）。それ以外の場合はグローバルコマンドとして登録されます（最大1時間の伝播、最大100個）。

### `handleCommandInteraction(...)`

#### パラメータ

* `interaction: CommandInteraction`: 処理するコマンドインタラクション

#### 戻り値

* `Promise<void>`

#### 説明

コマンドインタラクションを適切なハンドラーにルーティングします。組み込みコマンドは内部的に処理され、カスタムコマンドはプラグインシステムを介して登録できます。

### `sendMessageWithComponents(...)`

#### パラメータ

* `request: SendMessageRequest & { components: MessageComponent[] }`: コンポーネント付きメッセージ

#### 戻り値

* `Promise<DiscordMessage>`

#### 説明

インタラクティブコンポーネント（ボタン、セレクトメニュー）付きのメッセージを送信します。コンポーネントインタラクションを自動的に処理します。

### `showModal(...)`

#### パラメータ

* `interactionId: string`: インタラクショントークン
* `modal: Modal`: 表示するモーダル

#### 戻り値

* `Promise<void>`

#### 説明

コンポーネントインタラクションまたはコマンドに応答してモーダルダイアログを表示します。

### `createThread(...)`

#### パラメータ

* `options: ThreadCreateOptions`: スレッド作成オプション

#### 戻り値

* `Promise<DiscordChannel>`: 作成されたスレッドチャンネル

#### 説明

新しいスレッドを作成します。フォーラム投稿、アナウンススレッド、または通常のスレッドの作成に使用できます。

### `setPresence(...)`

#### パラメータ

* `presence: PresenceData`: 設定するプレゼンスデータ

#### 戻り値

* `Promise<void>`

#### 説明

ボットのプレゼンスステータスとアクティビティを更新します。

## イベント処理

Discordアダプターは、Social SDKインターフェースにマッピングされる正規化されたイベントを発行します：

| Discordイベント | Social SDKイベント | 説明 |
|:--------------|:-----------------|:------------|
| `messageCreate` | `message` | 新しいメッセージを受信 |
| `messageUpdate` | `messageUpdate` | メッセージが編集された |
| `messageDelete` | `messageDelete` | メッセージが削除された |
| `messageReactionAdd` | `reactionAdd` | リアクションが追加された |
| `messageReactionRemove` | `reactionRemove` | リアクションが削除された |
| `interactionCreate` | `interaction` | スラッシュコマンドまたはコンポーネントインタラクション |
| `typingStart` | `typingStart` | ユーザーが入力を開始した |
| `channelCreate` | `channelCreate` | チャンネルが作成された |
| `channelDelete` | `channelDelete` | チャンネルが削除された |
| `guildMemberAdd` | `memberJoin` | メンバーがギルドに参加した |
| `guildMemberRemove` | `memberLeave` | メンバーがギルドから退出した |
| `voiceStateUpdate` | `voiceStateChange` | ボイスチャンネルの参加/退出/移動 |

## 権限

Discord権限はbigintビットマスクとして表現されます：

```typescript
enum Permissions {
  CreateInstantInvite = 1n << 0n,
  KickMembers = 1n << 1n,
  BanMembers = 1n << 2n,
  Administrator = 1n << 3n,
  ManageChannels = 1n << 4n,
  ManageGuild = 1n << 5n,
  AddReactions = 1n << 6n,
  ViewAuditLog = 1n << 7n,
  PrioritySpeaker = 1n << 8n,
  Stream = 1n << 9n,
  ViewChannel = 1n << 10n,
  SendMessages = 1n << 11n,
  SendTTSMessages = 1n << 12n,
  ManageMessages = 1n << 13n,
  EmbedLinks = 1n << 14n,
  AttachFiles = 1n << 15n,
  ReadMessageHistory = 1n << 16n,
  MentionEveryone = 1n << 17n,
  UseExternalEmojis = 1n << 18n,
  ViewGuildInsights = 1n << 19n,
  Connect = 1n << 20n,
  Speak = 1n << 21n,
  MuteMembers = 1n << 22n,
  DeafenMembers = 1n << 23n,
  MoveMembers = 1n << 24n,
  UseVAD = 1n << 25n,
  ChangeNickname = 1n << 26n,
  ManageNicknames = 1n << 27n,
  ManageRoles = 1n << 28n,
  ManageWebhooks = 1n << 29n,
  ManageGuildExpressions = 1n << 30n,
  UseApplicationCommands = 1n << 31n,
  RequestToSpeak = 1n << 32n,
  ManageEvents = 1n << 33n,
  ManageThreads = 1n << 34n,
  CreatePublicThreads = 1n << 35n,
  CreatePrivateThreads = 1n << 36n,
  UseExternalStickers = 1n << 37n,
  SendMessagesInThreads = 1n << 38n,
  UseEmbeddedActivities = 1n << 39n,
  ModerateMembers = 1n << 40n,
  ViewCreatorMonetizationAnalytics = 1n << 41n,
  UseSoundboard = 1n << 42n,
  CreateGuildExpressions = 1n << 43n,
  CreateEvents = 1n << 44n,
  UseExternalSounds = 1n << 45n,
  SendVoiceMessages = 1n << 46n,
  SendPolls = 1n << 49n,
  UseExternalApps = 1n << 50n
}
```

## 設定

環境変数によるDiscord固有の設定：

**必須：**
* `DISCORD_BOT_TOKEN`: [Discord Developer Portal](https://discord.com/developers/applications)から取得したDiscordボットトークン
* `DISCORD_CLIENT_ID`: アプリケーションクライアントID

**オプション：**
* `DISCORD_INTENTS`: カンマ区切りリストとしてのゲートウェイインテント（デフォルト：`Guilds,GuildMessages,GuildMembers,GuildVoiceStates,GuildMessageReactions,GuildMessageTyping,DirectMessages,DirectMessageReactions,DirectMessageTyping,MessageContent`）
* `DISCORD_SHARD_COUNT`: シャード数（デフォルト：自動）
* `DISCORD_SHARD_IDS`: 実行する特定のシャードID（カンマ区切り）
* `DISCORD_PRESENCE_STATUS`: デフォルトのプレゼンスステータス（`online`、`idle`、`dnd`、`invisible`）
* `DISCORD_PRESENCE_ACTIVITY`: デフォルトのアクティビティ名
* `DISCORD_PRESENCE_ACTIVITY_TYPE`: アクティビティタイプ（`playing`、`listening`、`watching`、`competing`、`streaming`）
* `DISCORD_STREAMING_URL`: ストリーミングアクティビティ用のTwitch/YouTube URL
* `DISCORD_COMMAND_GUILD_ID`: スラッシュコマンドテスト用のギルドID（即時更新）
* `DISCORD_MESSAGE_CACHE_SIZE`: チャンネルあたりの最大キャッシュメッセージ数（デフォルト：100）
* `DISCORD_DISABLE_MENTIONS`: デフォルトですべてのメンションを無効にする場合は`true`に設定
* `DISCORD_ALLOWED_MENTIONS`: 許可されるメンションタイプ（デフォルト：`roles,users,everyone`）

## エラー処理

[`PlatformError`](/specifications/social-sdk/social-sdk#error-handling)を拡張するDiscord固有のエラータイプ：

```typescript
enum DiscordErrorType {
  // HTTPエラー
  UnknownAccount = 10001,
  UnknownApplication = 10002,
  UnknownChannel = 10003,
  UnknownGuild = 10004,
  UnknownIntegration = 10005,
  UnknownInvite = 10006,
  UnknownMember = 10007,
  UnknownMessage = 10008,
  UnknownPermissionOverwrite = 10009,
  UnknownProvider = 10010,
  UnknownRole = 10011,
  UnknownToken = 10012,
  UnknownUser = 10013,
  UnknownEmoji = 10014,
  UnknownWebhook = 10015,
  UnknownBan = 10026,
  
  // 一般エラー
  BotsCannotUse = 20001,
  OnlyBotsCanUse = 20002,
  CannotSendMessagesToUser = 50007,
  CannotSendMessagesInVoiceChannel = 50008,
  VerificationLevelTooHigh = 50009,
  OAuth2ApplicationLacksBot = 50010,
  OAuth2ApplicationLimitReached = 50011,
  InvalidOAuthState = 50012,
  MissingPermissions = 50013,
  InvalidAuthenticationToken = 50014,
  NoteTooLong = 50015,
  TooFewOrTooManyMessages = 50016,
  MessageCanOnlyBePinnedInChannelItWasSent = 50019,
  InviteCodeInvalidOrTaken = 50020,
  CannotExecuteOnSystemMessage = 50021,
  CannotExecuteOnChannelType = 50024,
  InvalidOAuthToken = 50025,
  MissingOAuthScope = 50026,
  InvalidWebhookToken = 50027,
  InvalidRole = 50028,
  InvalidRecipient = 50033,
  MessageTooOldToBulkDelete = 50034,
  InvalidFormBody = 50035,
  InviteAcceptedToGuildBotNotIn = 50036,
  InvalidActivityAction = 50039,
  InvalidAPIVersion = 50041,
  FileTooLarge = 50045,
  InvalidFileUploaded = 50046,
  CannotSelfRedeemGift = 50054,
  InvalidGuild = 50055,
  PaymentSourceRequired = 50070,
  CannotDeleteCommunityRequiredChannel = 50074,
  InvalidStickerSent = 50081,
  ThreadArchived = 50083,
  InvalidThreadNotificationSettings = 50084,
  ParameterEarlierThanCreation = 50085,
  GuildNotAvailableInLocation = 50095,
  GuildMonetizationRequired = 50097,
  
  // レート制限
  RateLimited = 429,
  
  // ゲートウェイエラー
  DisallowedGatewayIntent = 4014,
  DisallowedGatewayIntentPrivileged = 4013
}
```

## Social SDKとの統合

Discordアダプターは[`SocialPlatform`](/specifications/social-sdk/social-sdk#socialplatform-interface)インターフェースを実装しています：

| Social SDKメソッド | Discord実装 |
|:------------------|:-----------------------|
| `sendMessage` | `TextChannel.send()`を使用 |
| `sendDM` | `User.createDM()`でDMチャンネルを作成してから送信 |
| `addReaction` | `Message.react()`を使用 |
| `joinVoiceChannel` | [ボイスコール](/specifications/social-sdk/discord/voice-call)を参照 |
| `getChannel` | `Client.channels.fetch()`を使用 |
| `getUser` | `Client.users.fetch()`を使用 |

Discordの制限が適用される場合を除き、すべての機能は`true`に設定されています。
